name: Deploy Frontend Production
on:
  push:
    branches: ['master']
  workflow_dispatch: {}

concurrency:
  group: deploy-frontend-prod
  cancel-in-progress: true

jobs:
  deploy-frontend:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Upload project to EC2
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.PROD_EC2_HOST }}
          username: ${{ secrets.PROD_EC2_USER }}
          key: ${{ secrets.PROD_EC2_KEY }}
          source: '.'
          target: '/opt/pks/frontend'
          overwrite: true
          strip_components: 0
          debug: true
          timeout: 120s
          command_timeout: 120s

      - name: Deploy with Blue-Green Strategy
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.PROD_EC2_HOST }}
          username: ${{ secrets.PROD_EC2_USER }}
          key: ${{ secrets.PROD_EC2_KEY }}
          script_stop: true
          script: |
            set -euo pipefail
            cd /opt/pks/frontend

            # ìŠ¤í¬ë¦½íŠ¸ ì‹¤í–‰ ê¶Œí•œ ë¶€ì—¬
            chmod +x deploy-blue-green.sh

            # ë¸”ë£¨-ê·¸ë¦° ë°°í¬ ì‹¤í–‰
            ./deploy-blue-green.sh

            # ì‚¬ìš©í•˜ì§€ ì•ŠëŠ” Docker ì´ë¯¸ì§€ ì •ë¦¬
            docker image prune -f

            echo "ðŸŽ‰ Blue-Green deployment completed successfully!"

      - name: Final Health Check
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.PROD_EC2_HOST }}
          username: ${{ secrets.PROD_EC2_USER }}
          key: ${{ secrets.PROD_EC2_KEY }}
          script_stop: true
          script: |
            set -euo pipefail

            # ì›¹ì‚¬ì´íŠ¸ ìµœì¢… ì‘ë‹µ í™•ì¸
            echo "ðŸŒ Final website health check..."

            for i in {1..5}; do
              code=$(curl -sS -o /dev/null -w '%{http_code}' https://parkincare.com)
              if [ "$code" = "200" ] || [ "$code" = "304" ]; then
                echo "âœ… Health check passed: HTTP $code (attempt $i/5)"
                break
              elif [ $i -eq 5 ]; then
                echo "âŒ Health check failed: HTTP $code after 5 attempts"
                exit 1
              else
                echo "â³ Health check attempt $i/5: HTTP $code, retrying in 3s..."
                sleep 3
              fi
            done

            # í˜„ìž¬ í™œì„± í™˜ê²½ í™•ì¸
            ACTIVE_PORT=$(sudo nginx -T 2>/dev/null | grep "server 127.0.0.1:300[12]" | grep -o "300[12]" || echo "unknown")
            if [ "$ACTIVE_PORT" = "3001" ]; then
              ACTIVE_ENV="BLUE"
            elif [ "$ACTIVE_PORT" = "3002" ]; then
              ACTIVE_ENV="GREEN"  
            else
              ACTIVE_ENV="UNKNOWN"
            fi

            echo "ðŸ“Š Deployment Summary:"
            echo "   - Website Status: âœ… Healthy (HTTP $code)"
            echo "   - Active Environment: $ACTIVE_ENV (port $ACTIVE_PORT)"
            echo "   - Deployment Time: $(date)"
            echo ""
            echo "ðŸš€ Deployment completed successfully!"
