<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>PWA 영상 업로드 · 로컬 저장 전략 (시퀀스 다이어그램)</title>
  <script src="https://cdn.jsdelivr.net/npm/mermaid@10/dist/mermaid.min.js"></script>
  <script>
    mermaid.initialize({ startOnLoad: true, theme: "default", securityLevel: "loose" });
  </script>
  <style>
    body{font-family: ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Apple Color Emoji,Segoe UI Emoji; margin:0; padding:24px; background:#f7f8fb}
    .wrap{max-width:1100px; margin:0 auto}
    h1{font-size:20px; margin:0 0 12px}
    p.hint{color:#555; margin:0 0 18px}
    .card{background:#fff; border:1px solid #e6e8ef; border-radius:12px; padding:16px; box-shadow:0 2px 10px rgba(30,41,59,.06)}
  </style>
</head>
<body>
  <div class="wrap">
    <h1>🎥 PWA 영상 업로드 · 로컬 저장 전략 (Sequence Diagram)</h1>
    <p class="hint">단일 슬롯 IndexedDB(<code>video:enc</code>) + sessionStorage 결과 캐시 + Zustand(UI 파일/URL). 성공 시 즉시 삭제, 실패 시 최신 1개만 유지.</p>
    <div class="card">
<pre class="mermaid">
sequenceDiagram
  autonumber

  actor U as 사용자
  participant V as Video Page(UI)
  participant Z as Zustand(파일/URL)
  participant IDB as IndexedDB<br/>(video:enc, 단일 슬롯)
  participant API as API 서버
  participant SS as sessionStorage<br/>(result-{id}, TTL=10분)
  participant RP as Result Page
  participant RQ as React Query(SWR)

  U->>V: 파일 선택
  V->>Z: setFile(file)
  Z->>Z: createObjectURL → URL 저장
  V->>IDB: saveVideoTemp(file)<br/>(AES-GCM, TTL=10분)
  Note right of IDB: 항상 같은 키("video:enc")에 덮어쓰기 → 누적 불가

  U->>V: 업로드 버튼 클릭
  V->>API: POST /walking-record?date=YYYY-MM-DD<br/>(FormData 'uploadVideo')
  API-->>V: { id, payload }

  alt 업로드 성공
    V->>SS: setSessionResult(id, payload)<br/>(TTL=10분 + 체크섬)
    V->>IDB: clearVideoTemp()  %% 원본 즉시 삭제
    V->>RP: navigate(/video/result/:id)
    RP->>SS: getSessionResult(id)
    SS-->>RP: payload (즉시 렌더)
    RP->>RQ: /walking-record/:id 조회(백그라운드)
    RQ-->>RP: 최신 payload
    RP->>SS: setSessionResult(id, 최신)
  else 업로드 실패
    V->>IDB: 최신 실패본 1개만 유지(단일 슬롯)
    V-->>U: 오류 표시 + 재시도 옵션
  end

  opt 앱 시작/포그라운드
    V->>IDB: 만료(>10분)면 삭제(sweep)
  end
</pre>
    </div>
  </div>
</body>
</html>
