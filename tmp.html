<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>PWA ì˜ìƒ ì—…ë¡œë“œ Â· ë¡œì»¬ ì €ì¥ ì „ëµ (ì‹œí€€ìŠ¤ ë‹¤ì´ì–´ê·¸ë¨)</title>
  <script src="https://cdn.jsdelivr.net/npm/mermaid@10/dist/mermaid.min.js"></script>
  <script>
    mermaid.initialize({ startOnLoad: true, theme: "default", securityLevel: "loose" });
  </script>
  <style>
    body{font-family: ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Apple Color Emoji,Segoe UI Emoji; margin:0; padding:24px; background:#f7f8fb}
    .wrap{max-width:1100px; margin:0 auto}
    h1{font-size:20px; margin:0 0 12px}
    p.hint{color:#555; margin:0 0 18px}
    .card{background:#fff; border:1px solid #e6e8ef; border-radius:12px; padding:16px; box-shadow:0 2px 10px rgba(30,41,59,.06)}
  </style>
</head>
<body>
  <div class="wrap">
    <h1>ğŸ¥ PWA ì˜ìƒ ì—…ë¡œë“œ Â· ë¡œì»¬ ì €ì¥ ì „ëµ (Sequence Diagram)</h1>
    <p class="hint">ë‹¨ì¼ ìŠ¬ë¡¯ IndexedDB(<code>video:enc</code>) + sessionStorage ê²°ê³¼ ìºì‹œ + Zustand(UI íŒŒì¼/URL). ì„±ê³µ ì‹œ ì¦‰ì‹œ ì‚­ì œ, ì‹¤íŒ¨ ì‹œ ìµœì‹  1ê°œë§Œ ìœ ì§€.</p>
    <div class="card">
<pre class="mermaid">
sequenceDiagram
  autonumber

  actor U as ì‚¬ìš©ì
  participant V as Video Page(UI)
  participant Z as Zustand(íŒŒì¼/URL)
  participant IDB as IndexedDB<br/>(video:enc, ë‹¨ì¼ ìŠ¬ë¡¯)
  participant API as API ì„œë²„
  participant SS as sessionStorage<br/>(result-{id}, TTL=10ë¶„)
  participant RP as Result Page
  participant RQ as React Query(SWR)

  U->>V: íŒŒì¼ ì„ íƒ
  V->>Z: setFile(file)
  Z->>Z: createObjectURL â†’ URL ì €ì¥
  V->>IDB: saveVideoTemp(file)<br/>(AES-GCM, TTL=10ë¶„)
  Note right of IDB: í•­ìƒ ê°™ì€ í‚¤("video:enc")ì— ë®ì–´ì“°ê¸° â†’ ëˆ„ì  ë¶ˆê°€

  U->>V: ì—…ë¡œë“œ ë²„íŠ¼ í´ë¦­
  V->>API: POST /walking-record?date=YYYY-MM-DD<br/>(FormData 'uploadVideo')
  API-->>V: { id, payload }

  alt ì—…ë¡œë“œ ì„±ê³µ
    V->>SS: setSessionResult(id, payload)<br/>(TTL=10ë¶„ + ì²´í¬ì„¬)
    V->>IDB: clearVideoTemp()  %% ì›ë³¸ ì¦‰ì‹œ ì‚­ì œ
    V->>RP: navigate(/video/result/:id)
    RP->>SS: getSessionResult(id)
    SS-->>RP: payload (ì¦‰ì‹œ ë Œë”)
    RP->>RQ: /walking-record/:id ì¡°íšŒ(ë°±ê·¸ë¼ìš´ë“œ)
    RQ-->>RP: ìµœì‹  payload
    RP->>SS: setSessionResult(id, ìµœì‹ )
  else ì—…ë¡œë“œ ì‹¤íŒ¨
    V->>IDB: ìµœì‹  ì‹¤íŒ¨ë³¸ 1ê°œë§Œ ìœ ì§€(ë‹¨ì¼ ìŠ¬ë¡¯)
    V-->>U: ì˜¤ë¥˜ í‘œì‹œ + ì¬ì‹œë„ ì˜µì…˜
  end

  opt ì•± ì‹œì‘/í¬ê·¸ë¼ìš´ë“œ
    V->>IDB: ë§Œë£Œ(>10ë¶„)ë©´ ì‚­ì œ(sweep)
  end
</pre>
    </div>
  </div>
</body>
</html>
